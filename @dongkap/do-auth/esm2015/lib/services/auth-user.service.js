import { Injectable, Inject } from '@angular/core';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { API, HTTP_SERVICE, UserService, } from '@dongkap/do-core';
import * as i0 from "@angular/core";
import * as i1 from "./storage/profile-indexeddb.service";
export class AuthUserService extends UserService {
    constructor(profileIndexedDB, apiPath, httpBaseService) {
        super();
        this.profileIndexedDB = profileIndexedDB;
        this.apiPath = apiPath;
        this.httpBaseService = httpBaseService;
        this.loaderUserSubject$ = new Subject();
        this.destroy$ = new Subject();
    }
    ngOnDestroy() {
        this.destroy$.next(true);
        this.destroy$.complete();
        this.destroy$.unsubscribe();
    }
    loadUser() {
        this.profileIndexedDB.get('image').then((checksum) => {
            this.putImageBase64(checksum);
        });
        this.httpBaseService.HTTP_AUTH(this.apiPath['profile']['get-profile'])
            .pipe(takeUntil(this.destroy$))
            .subscribe((response) => {
            Promise.all([
                this.profileIndexedDB.put('name', response['name']),
                this.profileIndexedDB.put('email', response['email']),
                this.profileIndexedDB.put('image', response['image']),
            ]).then();
        });
    }
    updateName(name) {
        this.profileIndexedDB.put('name', name).then(() => {
            this.awaitUser();
        });
        return this.loaderUserSubject$.asObservable();
    }
    updatePhoto(checksum) {
        this.profileIndexedDB.put('image', checksum).then(() => {
            this.putImageBase64(checksum);
        });
        return this.loaderUserSubject$.asObservable();
    }
    get onUserChange() {
        this.awaitUser();
        return this.loaderUserSubject$.asObservable();
    }
    awaitUser() {
        Promise.all([
            this.profileIndexedDB.get('name'),
            this.profileIndexedDB.get('image-base64'),
        ]).then((value) => {
            const user = {
                name: value[0],
                image: value[1],
            };
            this.loaderUserSubject$.next(user);
        });
    }
    putImageBase64(checksum) {
        if (checksum) {
            this.httpBaseService.HTTP_AUTH(this.apiPath['profile']['get-photo-profile'], null, null, null, [checksum], 'arraybuffer')
                .pipe(takeUntil(this.destroy$))
                .subscribe((response) => {
                const imageBlob = new Blob([response], {
                    type: 'image/png',
                });
                const reader = new FileReader();
                reader.readAsDataURL(imageBlob);
                reader.onloadend = () => {
                    const imageBase64 = reader.result.toString();
                    this.profileIndexedDB.put('image-base64', imageBase64).then(() => {
                        this.awaitUser();
                    });
                };
            });
        }
    }
}
AuthUserService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AuthUserService, deps: [{ token: i1.ProfileIndexedDBService }, { token: API }, { token: HTTP_SERVICE }], target: i0.ɵɵFactoryTarget.Injectable });
AuthUserService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AuthUserService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: AuthUserService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ProfileIndexedDBService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [API]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [HTTP_SERVICE]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC11c2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AZG9uZ2thcC9kby1hdXRoL3NyYy9saWIvc2VydmljZXMvYXV0aC11c2VyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUNILEdBQUcsRUFHSCxZQUFZLEVBRVosV0FBVyxHQUNkLE1BQU0sa0JBQWtCLENBQUM7OztBQUkxQixNQUFNLE9BQU8sZUFBZ0IsU0FBUSxXQUFXO0lBRTVDLFlBQ1ksZ0JBQXlDLEVBQzdCLE9BQWlCLEVBQ1IsZUFBbUM7UUFDaEUsS0FBSyxFQUFFLENBQUM7UUFIQSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXlCO1FBQzdCLFlBQU8sR0FBUCxPQUFPLENBQVU7UUFDUixvQkFBZSxHQUFmLGVBQWUsQ0FBb0I7UUFJNUQsdUJBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQWEsQ0FBQztRQUM5QyxhQUFRLEdBQWlCLElBQUksT0FBTyxFQUFPLENBQUM7SUFIcEQsQ0FBQztJQUtELFdBQVc7UUFDVCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVNLFFBQVE7UUFDWCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQWdCLEVBQUUsRUFBRTtZQUN6RCxJQUFJLENBQUMsY0FBYyxD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QztnQkFDSCxNQUFNLE1BQU0sR0FBZSxJQUFJLFVBQVUsRUFBRSxDQUFDO2dCQUM1QyxNQUFNLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNoQyxNQUFNLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRTtvQkFDcEIsTUFBTSxXQUFXLEdBQVcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztvQkFDckQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTt3QkFDN0QsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO29CQUNyQixDQUFDLENBQUMsQ0FBQztnQkFDUCxDQUFDLENBQUM7WUFDTixDQUFDLENBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQzs7NkdBdEZRLGVBQWUseURBSVosR0FBRyxhQUNILFlBQVk7aUhBTGYsZUFBZTs0RkFBZixlQUFlO2tCQUQzQixVQUFVOzswQkFLRixNQUFNOzJCQUFDLEdBQUc7OzBCQUNWLE1BQU07MkJBQUMsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICAgIEFQSSxcbiAgICBBUElNb2RlbCxcbiAgICBIdHRwRmFjdG9yeVNlcnZpY2UsXG4gICAgSFRUUF9TRVJWSUNFLFxuICAgIFVzZXJNb2RlbCxcbiAgICBVc2VyU2VydmljZSxcbn0gZnJvbSAnQGRvbmdrYXAvZG8tY29yZSc7XG5pbXBvcnQgeyBQcm9maWxlSW5kZXhlZERCU2VydmljZSB9IGZyb20gJy4vc3RvcmFnZS9wcm9maWxlLWluZGV4ZWRkYi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEF1dGhVc2VyU2VydmljZSBleHRlbmRzIFVzZXJTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHByb2ZpbGVJbmRleGVkREI6IFByb2ZpbGVJbmRleGVkREJTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KEFQSSlwcml2YXRlIGFwaVBhdGg6IEFQSU1vZGVsLFxuICAgICAgICBASW5qZWN0KEhUVFBfU0VSVklDRSlwcml2YXRlIGh0dHBCYXNlU2VydmljZTogSHR0cEZhY3RvcnlTZXJ2aWNlKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsb2FkZXJVc2VyU3ViamVjdCQgPSBuZXcgU3ViamVjdDxVc2VyTW9kZWw+KCk7XG4gICAgcHJpdmF0ZSBkZXN0cm95JDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgICB0aGlzLmRlc3Ryb3kkLm5leHQodHJ1ZSk7XG4gICAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gICAgICB0aGlzLmRlc3Ryb3kkLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWRVc2VyKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIuZ2V0KCdpbWFnZScpLnRoZW4oKGNoZWNrc3VtOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHV0SW1hZ2VCYXNlNjQoY2hlY2tzdW0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5odHRwQmFzZVNlcnZpY2UuSFRUUF9BVVRIKFxuICAgICAgICAgICAgdGhpcy5hcGlQYXRoWydwcm9maWxlJ11bJ2dldC1wcm9maWxlJ10pXG4gICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCduYW1lJywgcmVzcG9uc2VbJ25hbWUnXSksXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5wdXQoJ2VtYWlsJywgcmVzcG9uc2VbJ2VtYWlsJ10pLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCdpbWFnZScsIHJlc3BvbnNlWydpbWFnZSddKSxcbiAgICAgICAgICAgICAgICBdKS50aGVuKCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlTmFtZShuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFVzZXJNb2RlbD4ge1xuICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCduYW1lJywgbmFtZSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmF3YWl0VXNlcigpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVQaG90byhjaGVja3N1bTogc3RyaW5nKTogT2JzZXJ2YWJsZTxVc2VyTW9kZWw+IHtcbiAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnaW1hZ2UnLCBjaGVja3N1bSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnB1dEltYWdlQmFzZTY0KGNoZWNrc3VtKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRlclVzZXJTdWJqZWN0JC5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG9uVXNlckNoYW5nZSgpOiBPYnNlcnZhYmxlPFVzZXJNb2RlbD4ge1xuICAgICAgICB0aGlzLmF3YWl0VXNlcigpO1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkZXJVc2VyU3ViamVjdCQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhd2FpdFVzZXIoKTogdm9pZCB7XG4gICAgICAgIFByb21pc2UuYWxsKFtcbiAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIuZ2V0KCduYW1lJyksXG4gICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLmdldCgnaW1hZ2UtYmFzZTY0JyksXG4gICAgICAgIF0pLnRoZW4oKHZhbHVlOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdXNlcjogVXNlck1vZGVsID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6IHZhbHVlWzBdLFxuICAgICAgICAgICAgICAgIGltYWdlOiB2YWx1ZVsxXSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmxvYWRlclVzZXJTdWJqZWN0JC5uZXh0KHVzZXIpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHB1dEltYWdlQmFzZTY0KGNoZWNrc3VtOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgaWYgKGNoZWNrc3VtKSB7XG4gICAgICAgICAgICB0aGlzLmh0dHBCYXNlU2VydmljZS5IVFRQX0FVVEgoXG4gICAgICAgICAgICB0aGlzLmFwaVBhdGhbJ3Byb2ZpbGUnXVsnZ2V0LXBob3RvLXByb2ZpbGUnXSwgbnVsbCwgbnVsbCwgbnVsbCxcbiAgICAgICAgICAgIFtjaGVja3N1bV0sICdhcnJheWJ1ZmZlcicpXG4gICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW1hZ2VCbG9iID0gbmV3IEJsb2IoW3Jlc3BvbnNlXSwge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW1hZ2UvcG5nJyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCByZWFkZXI6IEZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGltYWdlQmxvYik7XG4gICAgICAgICAgICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1hZ2VCYXNlNjQ6IHN0cmluZyA9IHJlYWRlci5yZXN1bHQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnaW1hZ2UtYmFzZTY0JywgaW1hZ2VCYXNlNjQpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hd2FpdFVzZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG59XG4iXX0=